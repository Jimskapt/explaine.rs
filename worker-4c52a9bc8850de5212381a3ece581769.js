const isWorker=typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope;const LOAD="load";const READY="ready";const COMPILED="compiled";const COMPILATION_ERROR="compilation-error";const COMPILE="compile";const EXPLAIN="explain";const EXPLANATION="explanation";const ELABORATE="elaborate";const ELABORATION="elaboration";const EXPLORATION="exploration";let promise=isWorker?workerMain():main();promise.catch(e=>console.error(e));async function main(){await import("../node_modules/codemirror/lib/codemirror.js");await import("../node_modules/codemirror/addon/mode/simple.js");await import("../node_modules/codemirror/mode/rust/rust.js");let state={compilation:{state:"pending"}};let nonUiState={lastRule:-1};const explanation=document.querySelector("#explanation");const itemContainer=explanation.querySelector(".item-container");const itemTitle=itemContainer.querySelector(".item-title");const item=itemContainer.querySelector(".item");const error=document.querySelector(".error");const generate=document.querySelector(".generate");const link=document.querySelector(".link");const moreInfo=explanation.querySelector(".more-info");const bookRow=moreInfo.querySelector(".book-row");const bookEl=bookRow.querySelector("a");const keywordRow=moreInfo.querySelector(".keyword-row");const keywordEl=keywordRow.querySelector("a");const styleEl=document.createElement("style");document.head.appendChild(styleEl);const styleSheet=styleEl.sheet;const showAll=document.querySelector(".show-all");let hoverIndex;const initialItem=item.innerHTML;const initialItemTitle=itemTitle.innerHTML;const initialShowAll=showAll.textContent;const setState=(renderFn=>{let next={};let nextRender=null;const doRender=()=>{const newState=Object.assign({},state,next);const prevState=state;state=newState;next={};nextRender=null;renderFn(prevState)};return nextState=>{Object.assign(next,nextState||{});console.info("setState: ",nextState);if(nextRender==null){nextRender=window.requestAnimationFrame(()=>doRender())}}})(prevState=>{if(prevState.compilation!=state.compilation){renderSessionState()}if(prevState.compilation.explanation!==state.compilation.explanation){renderExplanation()}if(prevState.compilation.elaboration!==state.compilation.elaboration){renderElaboration()}if(prevState.compilation.hoverEl!==state.compilation.hoverEl){renderHover()}if(prevState.compilation.address!==state.compilation.address){renderGeneratedLink()}if(prevState.compilation.exploration!==state.compilation.exploration){renderExploration()}if(prevState.compilation.showAll!==state.compilation.showAll){renderShowAll()}});const worker=new Worker(window.workerMain,{name:"explainer"});worker.onerror=e=>console.error(e);worker.onmessage=e=>{const{data:data}=e;console.info("Window received",data.type);switch(data.type){case READY:setState({compilation:{state:"pending"}});compileSession();break;case COMPILED:setState({compilation:{state:"success"}});break;case COMPILATION_ERROR:setState({compilation:{state:"error"}});break;case EXPLANATION:setState({compilation:{...state.compilation,explanation:data.location}});onExplanation();break;case ELABORATION:setState({compilation:{...state.compilation,elaboration:data.location!=null?data:null}});break;case EXPLORATION:computeExploration(data.exploration);setState({compilation:{...state.compilation,exploration:true}});break;default:console.error("Unexpected message in window",data)}};worker.postMessage({type:LOAD,url:window.workerBundle,wasmUrl:window.workerWasm});generate.addEventListener("click",()=>{let address=`${window.location.origin}/?code=${window.encodeURIComponent(cm.getValue())}`;setState({compilation:{...state.compilation,address:address}})});function renderGeneratedLink(){const{address:address}=state.compilation;if(address){generate.style.display="none";link.classList.remove("hidden");link.href=address}else{link.classList.add("hidden");generate.style.display=null}}const cm=CodeMirror.fromTextArea(document.querySelector("#editor"),{mode:"rust",lineNumbers:true,theme:"solarized"});const codeParam=[...new window.URLSearchParams(location.search)].find(([key,value])=>key==="code");const code=codeParam!=null?window.decodeURIComponent(codeParam[1]):null;if(code!=null&&code.trim()!==""){cm.setValue(code)}else{const local=window.localStorage.getItem("code");if(local!=null){cm.setValue(local)}}function renderSessionState(){if(isFailedCompilation(state.compilation)){error.style.display="inherit";wait(()=>{if(isFailedCompilation(state.compilation)){error.style.opacity=1}})}else{error.style.display="none";error.style.opacity="0"}}function wait(fn){requestAnimationFrame(()=>requestAnimationFrame(()=>fn()))}function isFailedCompilation(compilation){return compilation!=null&&compilation.state==="error"}cm.on("change",()=>{setState({compilation:{state:"pending"}});compileSession()});cm.getWrapperElement().addEventListener("mousemove",e=>{if(nonUiState.computedMarks){setState({compilation:{...state.compilation,hoverEl:e.target}});return}const{compilation:compilation}=state;const{clientX:clientX,clientY:clientY}=e;if(compilation.state!=="success"||nonUiState.computing){compilation.next={clientX:clientX,clientY:clientY};return}nonUiState.computing=true;explain(clientX,clientY)});showAll.addEventListener("click",()=>{setState({compilation:{...state.compilation,showAll:!state.compilation.showAll}})});function compileSession(){const code=cm.getValue();window.localStorage.setItem("code",code);if(code.trim()==="")return;worker.postMessage({type:COMPILE,source:cm.getValue()});const{computedMarks:computedMarks}=nonUiState;nonUiState.computedMarks=null;computedMarks&&requestAnimationFrame(()=>computedMarks.forEach(mark=>mark.clear()))}function computeExploration(exploration){nonUiState.computedMarks=exploration.map(({start:start,end:end},i)=>getMark({start:start,end:end},`computed-${i}`));for(let i=nonUiState.lastRule+1;i<exploration.length;i++){styleSheet.insertRule(`.hover-${i} .computed-${i} { background: #eee8d5 }`,styleSheet.cssRules.length)}nonUiState.lastRule=Math.max(exploration.length,nonUiState.lastRule);nonUiState.hoverMark&&nonUiState.hoverMark.clear()}function explain(left,top){const{compilation:compilation}=state;if(compilation.state!=="success")return;let{line:line,ch:ch}=cm.coordsChar({left:left,top:top},"window");const lastLocation=nonUiState.lastLocation||{};if(line===lastLocation.line&&ch===lastLocation.ch){nonUiState.computing=false;return}nonUiState.lastLocation={line:line,ch:ch};worker.postMessage({type:EXPLAIN,location:{line:line,ch:ch}})}function onExplanation(){nonUiState.computing=false;if(nonUiState.next){const{clientX:clientX,clientY:clientY}=nonUiState.next;nonUiState.next=null;explain(clientX,clientY)}}function renderExplanation(){const location=state.compilation.explanation;nonUiState.hoverMark&&nonUiState.hoverMark.clear();if(location==null)return;nonUiState.hoverMark=getMark(location)}function getMark(location,className="highlighted"){return cm.markText(location.start,location.end,{className:className})}cm.getWrapperElement().addEventListener("click",()=>{elaborate(cm.getCursor("from"))});function elaborate(location){if(state.compilation.state!=="success")return;worker.postMessage({type:ELABORATE,location:location})}function renderElaboration(){const{elaboration:elaboration}=state.compilation;nonUiState.mark&&nonUiState.mark.clear();nonUiState.hoverMark&&nonUiState.hoverMark.clear();if(elaboration!=null){nonUiState.mark=getMark(elaboration.location);itemTitle.innerHTML=elaboration.title;item.innerHTML=elaboration.elaboration;if(elaboration.book||elaboration.keyword){moreInfo.style.display="block";bookRow.style.display=elaboration.book?"block":"none";keywordRow.style.display=elaboration.keyword?"block":"none";bookEl.href=elaboration.book||"";keywordEl.href=elaboration.keyword||""}else{moreInfo.style.display="none"}}else{itemTitle.innerHTML=initialItemTitle;item.innerHTML=initialItem;moreInfo.style.display="none"}}function renderHover(){const{hoverEl:hoverEl}=state.compilation;const klass=hoverEl&&[...hoverEl.classList].find(klass=>klass.startsWith("computed-"));const newIndex=klass&&Number(klass.replace("computed-",""));if(hoverIndex!=null&&newIndex!==hoverIndex){cm.getWrapperElement().classList.remove(`hover-${hoverIndex}`)}if(newIndex!=null){cm.getWrapperElement().classList.add(`hover-${newIndex}`)}hoverIndex=newIndex}function renderExploration(){console.warn("renderExploration");showAll.disabled=!state.compilation.exploration;if(showAll.disabled){showAll.textContent=initialShowAll}}function renderShowAll(){if(state.compilation.showAll){cm.getWrapperElement().classList.add("show-all-computed");showAll.textContent="Hide elements"}else{cm.getWrapperElement().classList.remove("show-all-computed");showAll.textContent=initialShowAll}}window.cm=cm}async function workerMain(){console.info("workerMain");const state={source:null,session:null,explanation:null,exploration:null};self.onmessage=e=>{const{data:data}=e;console.info("Worker received",data.type);switch(data.type){case LOAD:load(data.url,data.wasmUrl);break;case COMPILE:compile(data.source);break;case EXPLAIN:explain(data.location);break;case ELABORATE:elaborate(data.location);break;default:console.error("Unexpected message in worker",data)}};async function load(url,wasmUrl){self.importScripts(url);try{await wasm_bindgen(wasmUrl)}catch(e){console.error(e);return}postMessage({type:READY})}function compile(source){if(state.session){state.session.free();state.session=null}state.session=wasm_bindgen.Session.new(source);exploreLoop(state.session,true);notifySession()}function notifySession(){postMessage({type:state.session!=null?COMPILED:COMPILATION_ERROR})}function exploreLoop(session,init=false){if(session!=state.session||state.session==null){return}const LENGTH=10;if(init){state.exploration={buffer:new self.Uint32Array(LENGTH*4),result:[]}}const{buffer:buffer,result:result}=state.exploration;const written=state.session.explore(buffer,LENGTH);if(written===0){console.info("Exploration finished...");postMessage({type:EXPLORATION,exploration:state.exploration.result.map(range=>({start:{line:range[0][0],ch:range[0][1]},end:{line:range[1][0],ch:range[1][1]}}))});return}for(let i=0;i<written;i++){state.exploration.result.push([[buffer[4*i]-1,buffer[4*i+1]],[buffer[4*i+2]-1,buffer[4*i+3]]])}setTimeout(()=>exploreLoop(session))}function explain(location){doExplain(location);notifyExplanation()}function elaborate(location){doExplain(location);notifyElaboration()}function doExplain(location){if(state.explanation){state.explanation.free();state.explanation=null}state.explanation=state.session&&state.session.explain(location.line+1,location.ch)}function notifyExplanation(){postMessage({type:EXPLANATION,location:explanationLocation(state.explanation)})}function notifyElaboration(){postMessage({type:ELABORATION,location:explanationLocation(state.explanation),elaboration:state.explanation&&state.explanation.elaborate(),title:state.explanation&&state.explanation.title(),book:state.explanation&&state.explanation.book(),keyword:state.explanation&&state.explanation.keyword()})}function explanationLocation(explanation){return explanation!=null?{start:{line:explanation.start_line-1,ch:explanation.start_column},end:{line:explanation.end_line-1,ch:explanation.end_column}}:null}}
