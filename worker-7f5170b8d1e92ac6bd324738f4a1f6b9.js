const isWorker=typeof WorkerGlobalScope!=="undefined"&&self instanceof WorkerGlobalScope;const LOAD="load";const READY="ready";const COMPILED="compiled";const COMPILATION_ERROR="compilation-error";const COMPILE="compile";const EXPLAIN="explain";const EXPLANATION="explanation";const ELABORATE="elaborate";const ELABORATION="elaboration";let promise=isWorker?workerMain():main();promise.catch(e=>console.error(e));async function main(){await import("../node_modules/codemirror/lib/codemirror.js");await import("../node_modules/codemirror/addon/mode/simple.js");await import("../node_modules/codemirror/mode/rust/rust.js");let state={compilation:null};const worker=new Worker(window.workerMain,{name:"explainer"});worker.onerror=e=>console.error(e);worker.onmessage=e=>{const{data:data}=e;console.info("Window received",data.type);console.info("Window state:",state);switch(data.type){case READY:state.compilation={state:"pending"};compileSession();break;case COMPILED:state.compilation={state:"success"};displaySessionState();break;case COMPILATION_ERROR:state.compilation={state:"error"};displaySessionState();break;case EXPLANATION:if(state.compilation){state.compilation.explanation=data.location;state.compilation.computing=false;displayExplanationLocation()}break;case ELABORATION:if(state.compilation){state.compilation.elaboration=data.location!=null?{location:data.location,elaboration:data.elaboration,title:data.title}:null;displayElaboration()}break;default:console.error("Unexpected message in window",data)}console.info("Window state after:",state)};worker.postMessage({type:LOAD,url:window.workerBundle,wasmUrl:window.workerWasm});const explanation=document.querySelector("#explanation");const itemContainer=explanation.querySelector(".item-container");const itemTitle=itemContainer.querySelector(".item-title");const item=itemContainer.querySelector(".item");const error=document.querySelector(".error");const cm=CodeMirror.fromTextArea(document.querySelector("#editor"),{mode:"rust",lineNumbers:true,theme:"solarized"});function displaySessionState(){const{compilation:compilation}=state;if(isFailedCompilation()){error.style.display="inherit";wait(()=>{if(isFailedCompilation()){error.style.opacity=1}})}else{error.style.display="none";error.style.opacity="0"}}function wait(fn){requestAnimationFrame(()=>requestAnimationFrame(()=>fn()))}function isFailedCompilation(){return state.compilation!=null&&state.compilation.state==="error"}cm.on("change",()=>{compileSession()});cm.getWrapperElement().addEventListener("mousemove",e=>{const{compilation:compilation}=state;if(compilation==null||compilation.state!=="success"||compilation.computing){return}compilation.computing=true;const{clientX:clientX,clientY:clientY}=e;explain(clientX,clientY)});function compileSession(){const code=cm.getValue();if(code.trim()==="")return;worker.postMessage({type:COMPILE,source:cm.getValue()})}function explain(left,top){const{compilation:compilation}=state;if(compilation==null||compilation.state!=="success")return;let{line:line,ch:ch}=cm.coordsChar({left:left,top:top},"window");const lastLocation=compilation.lastLocation||{};if(line===lastLocation.line&&ch===lastLocation.ch){compilation.computing=false;return}compilation.lastLocation={line:line,ch:ch};worker.postMessage({type:EXPLAIN,location:{line:line,ch:ch}})}function displayExplanationLocation(){const location=state.compilation&&state.compilation.explanation;state.compilation.hoverMark&&state.compilation.hoverMark.clear();if(location==null)return;state.compilation.hoverMark=getMark(location)}function getMark(location){return cm.markText(location.start,location.end,{className:"highlighted"})}cm.getWrapperElement().addEventListener("click",()=>{elaborate(cm.getCursor("from"))});function elaborate(location){if((state.compilation&&state.compilation.state)!=="success")return;worker.postMessage({type:ELABORATE,location:location})}function displayElaboration(){const{compilation:compilation}=state;compilation.mark&&compilation.mark.clear();if((compilation&&compilation.elaboration)==null)return;compilation.hoverMark&&compilation.hoverMark.clear();compilation.mark=getMark(compilation.elaboration.location);itemTitle.innerHTML=compilation.elaboration.title;item.innerHTML=compilation.elaboration.elaboration}window.cm=cm}async function workerMain(){console.info("workerMain");const state={source:null,session:null,explanation:null};self.onmessage=e=>{const{data:data}=e;console.info("Worker received",data.type);switch(data.type){case LOAD:load(data.url,data.wasmUrl);break;case COMPILE:compile(data.source);break;case EXPLAIN:explain(data.location);break;case ELABORATE:elaborate(data.location);break;default:console.error("Unexpected message in worker",data)}};async function load(url,wasmUrl){self.importScripts(url);try{await wasm_bindgen(wasmUrl)}catch(e){console.error(e);return}postMessage({type:READY})}function compile(source){if(state.session){state.session.free();state.session=null}state.session=wasm_bindgen.Session.new(source);notifySession()}function notifySession(){postMessage({type:state.session!=null?COMPILED:COMPILATION_ERROR})}function explain(location){doExplain(location);notifyExplanation()}function elaborate(location){doExplain(location);notifyElaboration()}function doExplain(location){if(state.explanation){state.explanation.free();state.explanation=null}state.explanation=state.session&&state.session.explain(location.line+1,location.ch)}function notifyExplanation(){postMessage({type:EXPLANATION,location:explanationLocation(state.explanation)})}function notifyElaboration(){postMessage({type:ELABORATION,location:explanationLocation(state.explanation),elaboration:state.explanation&&state.explanation.elaborate(),title:state.explanation&&state.explanation.title()})}function explanationLocation(explanation){return explanation!=null?{start:{line:explanation.start_line-1,ch:explanation.start_column},end:{line:explanation.end_line-1,ch:explanation.end_column}}:null}}
